stages:
  - test
  - stats
  - deploy
  - release

stylecheck:
  stage: test
  tags:
    - python3
  script:
    - python3 -m venv virtual && source virtual/bin/activate && pip install ci-scripts
    - python-codestyle-check

unittest:
  stage: test
  tags:
    - python3
    - progstats
  script:
    - python3 -m venv virtual && source virtual/bin/activate && pip install ci-scripts
    - python-unittest

gitstats:
  stage: stats
  tags:
    - python3
    - gitstats
    - progstats
  script:
    - python3 -m venv virtual && source virtual/bin/activate && pip install ci-scripts
    - gitstats-gen

docgen:
  stage: stats
  tags:
    - python3
    - progstats
  script:
    - python3 -m venv virtual && source virtual/bin/activate && pip install ci-scripts
    - sphinx-docgen

deploy_kudubot:
  stage: deploy
  only:
    - master
    - develop
  tags:
    - python3
    - kudubot-telegram
    #- kudubot-whatsapp
  script:
    - sudo systemctl stop kudubot-telegram.service
    #- sudo systemctl stop kudubot-whatsapp.service
    - rm -rf ~/kudubot
    - python3 -m venv ~/kudubot && source ~/kudubot/bin/activate && python setup.py install
    - rm ~/.kudubot/services.conf ~/.kudubot/connections.conf -f
    - kudubot-config-gen
    - echo $KUDUBOT_TELEGRAM_CONFIG > ~/.kudubot/connection_config/telegram.conf
    #- echo $KUDUBOT_WHATSAPP_CONFIG > ~/.kudubot/connection_config/whatsapp.conf
    - sudo systemctl start kudubot-telegram.service
    #- sudo systemctl start kudubot-whatsapp.service

release_upload:
  stage: release
  only:
    - master
  tags:
    - python3
  script:
    - python3 -m venv virtual && source virtual/bin/activate && pip install ci-scripts
    - github-release-upload $(cat version) "$(changelog-reader)"
    - gitlab-release-upload $(cat version) "$(changelog-reader)"

pypi_upload:
  stage: release
  only:
    - master
  tags:
    - python3
  script:
    - python3 -m venv virtual && source virtual/bin/activate && pip install ci-scripts
    - pypi-upload
